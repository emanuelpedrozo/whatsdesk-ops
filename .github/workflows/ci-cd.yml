name: CI/CD

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ci-cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npm run prisma:generate -w @crm/api

      - name: Build API
        run: npm run build -w @crm/api

      - name: Build Web
        env:
          NEXT_PUBLIC_API_URL: http://localhost:3001/api
          NEXT_PUBLIC_RT_URL: http://localhost:3001/realtime
          NEXT_BASE_PATH: ""
        run: npm run build -w @crm/web

      - name: Run API tests
        run: npm run test -w @crm/api

  deploy:
    name: Deploy to Hetzner
    runs-on: ubuntu-latest
    needs: ci
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Deploy via SSH
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          set -euo pipefail

          if [ -z "${SSH_HOST}" ] || [ -z "${SSH_USER}" ] || [ -z "${SSH_PRIVATE_KEY}" ]; then
            echo "Missing SSH secrets. Configure SSH_HOST, SSH_USER and SSH_PRIVATE_KEY."
            exit 1
          fi

          PORT="${SSH_PORT:-22}"
          TARGET_PATH="${DEPLOY_PATH:-/opt/whatsdesk-ops}"

          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf "%s" "${SSH_PRIVATE_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p "${PORT}" -H "${SSH_HOST}" >> ~/.ssh/known_hosts

          ssh -p "${PORT}" "${SSH_USER}@${SSH_HOST}" <<EOF
          set -euo pipefail
          cd "${TARGET_PATH}"

          git fetch origin main
          git checkout main
          git pull --ff-only origin main

          npm ci
          npm run prisma:generate -w @crm/api
          npm run build -w @crm/api
          npm run build -w @crm/web
          npm run prisma:migrate -w @crm/api

          pm2 restart whatsdesk-api --update-env || pm2 start "npm run start -w @crm/api" --name whatsdesk-api
          pm2 restart whatsdesk-web --update-env || pm2 start "npm run start -w @crm/web" --name whatsdesk-web
          pm2 save
          EOF
